name: Oracle Cloud VM Provisioner

on:
  schedule:
    # Runs every 5 minutes (GitHub minimum)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  provision-vm:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if VM already exists
        id: check
        env:
          OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_CLI_REGION: eu-frankfurt-1
        run: |
          # Install OCI CLI
          pip install oci-cli --quiet
          
          # Setup config
          mkdir -p ~/.oci
          echo "$OCI_CLI_KEY_CONTENT" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem
          
          cat > ~/.oci/config << EOF
          [DEFAULT]
          user=$OCI_CLI_USER
          fingerprint=$OCI_CLI_FINGERPRINT
          key_file=~/.oci/oci_api_key.pem
          tenancy=$OCI_CLI_TENANCY
          region=$OCI_CLI_REGION
          EOF
          
          # Check if instance already exists
          INSTANCES=$(oci compute instance list \
            --compartment-id "$OCI_CLI_TENANCY" \
            --display-name "Clawdbot-Server" \
            --lifecycle-state RUNNING \
            --query 'data[0].id' \
            --raw-output 2>/dev/null || echo "")
          
          if [ -n "$INSTANCES" ] && [ "$INSTANCES" != "null" ]; then
            echo "VM already exists! OCID: $INSTANCES"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "No running VM found, will attempt to create"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create VM (if not exists)
        if: steps.check.outputs.exists == 'false'
        env:
          OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
          OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
          OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
          OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_PRIVATE_KEY }}
          OCI_CLI_REGION: eu-frankfurt-1
        run: |
          # Variables
          COMPARTMENT_ID="${{ secrets.OCI_TENANCY_OCID }}"
          SUBNET_ID="ocid1.subnet.oc1.eu-frankfurt-1.aaaaaaaad4qpodixqeoniakci3ys6k7jukw5srk36rzlpxpa5w7tmwmxtdra"
          IMAGE_ID="ocid1.image.oc1.eu-frankfurt-1.aaaaaaaajzudgoto32j5q245xjkm2p7nj6rrza2bb5yyqjgm56k4ib2to6sq"
          SSH_KEY="${{ secrets.SSH_PUBLIC_KEY }}"
          
          ADS=("OGQp:EU-FRANKFURT-1-AD-1" "OGQp:EU-FRANKFURT-1-AD-2" "OGQp:EU-FRANKFURT-1-AD-3")
          
          for AD in "${ADS[@]}"; do
            echo "Trying AD: $AD..."
            
            RESULT=$(oci compute instance launch \
              --compartment-id "$COMPARTMENT_ID" \
              --availability-domain "$AD" \
              --shape "VM.Standard.A1.Flex" \
              --shape-config '{"ocpus": 4, "memoryInGBs": 24}' \
              --display-name "Clawdbot-Server" \
              --image-id "$IMAGE_ID" \
              --subnet-id "$SUBNET_ID" \
              --ssh-authorized-keys "$SSH_KEY" \
              --assign-public-ip true \
              2>&1) || true
            
            if echo "$RESULT" | grep -q '"lifecycle-state": "PROVISIONING"'; then
              echo "üéâ SUCCESS! VM created in $AD"
              echo "$RESULT"
              exit 0
            elif echo "$RESULT" | grep -q "Out of host capacity"; then
              echo "‚ùå No capacity in $AD"
            else
              echo "Unexpected result: $RESULT"
            fi
            
            sleep 2
          done
          
          echo "No capacity in any AD. Will retry next run."
          exit 0  # Don't fail the workflow, just retry later

      - name: Notify Success
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "‚úÖ VM is already running! No action needed."
          echo "You can disable this workflow now."
